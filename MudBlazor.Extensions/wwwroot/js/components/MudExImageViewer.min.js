export function initializeMudExImageViewer(t,i,r){return new n(t,i,r)}class n{elementRef;dotnet;startPoint;endPoint;_isSelecting;_selectionMode;constructor(n,t,i){this.elementRef=n;this.dotnet=t;this.options=i;i&&i.src&&this.createViewer(i)}createViewer(n,t,i,r){if(this.container=t,this.buttonContainer=r,this.selectionDiv=i,this.options=n,this.destroyViewer(),document.removeEventListener("keyup",this._onKeyUp),window.MudExImageView)try{this.viewer=window.MudExImageView({id:n.id,prefixUrl:"",maxZoomPixelRatio:n.maxZoomPixelRatio,minZoomLevel:n.minZoomLevel,animationTime:n.animationTime,tileSources:{type:"image",url:n.src},showNavigator:n.showNavigator,navigatorPosition:n.navigatorPosition,navigatorSizeRatio:n.navigatorSizeRatio,navigatorMaintainSizeRatio:!1,navigatorAutoResize:!1,showNavigationControl:!1});this.createRubberBandSelection();n.showNavigator&&this.viewer.addHandler("open",()=>{var t=this.elementRef.querySelector(".navigator"),i;t&&(n.navigatorClass&&(t.style.backgroundColor=t.style.background=null,t.classList.add(n.navigatorClass)),n.navigatorRectangleColor&&(i=t.querySelector(".displayregion"),i&&(i.style.border="2px solid "+n.navigatorRectangleColor)))});document.addEventListener("keyup",this._onKeyUp);this.dotnet.invokeMethodAsync("OnViewerCreated")}catch(u){console.error(u)}}_onKeyUp=n=>{if((this._isSelecting&&n.key==="Control")||n.key==="Escape"){if(this.selectionDiv.style.display!=="none"){this.hideRubberBand();n.preventDefaultAction=true}else{this.reset()}}};getCanvas(){return this.viewer.canvas.querySelector("canvas")}toggleRubberBandSelection(n){this._isSelecting=this._selectionMode=n;n||this.options.allowInteractingUnderRubberBand||this.hideRubberBand()}setRubberBandDimensions(n,t,i,r,u){this.selectionDiv.style.left=`${n}px`;this.selectionDiv.style.top=`${t}px`;this.selectionDiv.style.width=`${i}px`;this.selectionDiv.style.height=`${r}px`;u&&(this.selectionDiv.style.display=u)}hideRubberBand(){this.selectionDiv&&(this.selectionDiv.style.display="none");this.buttonContainer&&(this.buttonContainer.style.display="none");this.startPoint=null;this._isSelecting=!1}createRubberBandSelection(){this.options.allowRubberBandSelection&&(this.buttonContainer.style.position="absolute",this.buttonContainer.style.display="none",this.options.allowInteractingUnderRubberBand||this.viewer.addHandler("zoom",()=>{this.hideRubberBand()}),this.viewer.addHandler("canvas-press",n=>{if(n.originalEvent.ctrlKey||this._selectionMode){this.hideRubberBand();this._isSelecting=!0;var t=MudExImageView.getMousePosition(n.originalEvent);t=this.relativePosition(t,this.container);this.startPoint=new MudExImageView.Point(t.x,t.y);this.setRubberBandDimensions(t.x,t.y,0,0,"block");n.preventDefaultAction=!0}else this.options.allowInteractingUnderRubberBand||this.hideRubberBand()}),this.viewer.addHandler("canvas-drag",n=>{if(this._isSelecting&&this.startPoint){let t=MudExImageView.getMousePosition(n.originalEvent);t=this.relativePosition(t,this.container);const i=Math.min(this.startPoint.x,t.x),r=Math.min(this.startPoint.y,t.y),u=Math.abs(this.startPoint.x-t.x),f=Math.abs(this.startPoint.y-t.y);this.setRubberBandDimensions(i,r,u,f);n.preventDefaultAction=!0}}),this.viewer.addHandler("canvas-drag-end",async n=>{if(this._isSelecting&&this.startPoint){let i=MudExImageView.getMousePosition(n.originalEvent);i=this.relativePosition(i,this.container);this.endPoint=new MudExImageView.Point(i.x,i.y);const f=this.viewer.viewport.pointFromPixel(this.startPoint),e=this.viewer.viewport.pointFromPixel(this.endPoint),r=this.viewer.viewport.viewportToImageCoordinates(f),u=this.viewer.viewport.viewportToImageCoordinates(e);var t=new MudExImageView.Rect(Math.min(r.x,u.x),Math.min(r.y,u.y),Math.abs(r.x-u.x),Math.abs(r.y-u.y));this._isSelecting=!1;this.buttonContainer.style.display="flex";this.buttonContainer.style.top=`${parseInt(this.selectionDiv.style.top)+parseInt(this.selectionDiv.style.height)+5}px`;this.buttonContainer.style.left=`${parseInt(this.selectionDiv.style.left)+parseInt(this.selectionDiv.style.width)-this.buttonContainer.getBoundingClientRect().width}px`;n.preventDefaultAction=!0;this.dotnet.invokeMethodAsync("OnAreaSelected",t,this.selectionDiv.getBoundingClientRect(),await this.getSelectedAreaImageData("bytes"),await this.getSelectedAreaImageData("blob"))}}))}relativePosition(n,t){const i=t.getBoundingClientRect();return{x:n.x-i.left,y:n.y-i.top}}getSelectedAreaImageData(n="dataURL"){if(!this.startPoint||!this.endPoint)return null;const u=this.getCanvas(),f=Math.min(this.startPoint.x,this.endPoint.x),e=Math.min(this.startPoint.y,this.endPoint.y),i=Math.abs(this.startPoint.x-this.endPoint.x),r=Math.abs(this.startPoint.y-this.endPoint.y),t=document.createElement("canvas");t.width=i;t.height=r;const o=t.getContext("2d");o.drawImage(u,f,e,i,r,0,0,i,r);switch(n){case"blob":return new Promise(n=>{t.toBlob(t=>n(URL.createObjectURL(t)),"image/png")});case"bytes":return new Promise(n=>{t.toBlob(t=>{const i=new FileReader;i.onload=function(){n(new Uint8Array(this.result))};i.readAsArrayBuffer(t)},"image/png")});default:return t.toDataURL("image/png")}}zoomBy(n){this.viewer.viewport.zoomBy(n);this.viewer.viewport.applyConstraints()}reset(){this.viewer.viewport.goHome();this.viewer.viewport.applyConstraints()}getCurrentViewImageDataUrl(){return this.viewer.drawer.canvas.toDataURL("image/png")}print(n=""){var t=window.open("","_blank"),i;t.document.open();t.document.write("<html><head><\/head><body>");i=new Image;i.src=n||this.getCurrentViewImageDataUrl();i.onload=function(){t.document.body.appendChild(i);i.onload=function(){t.focus();t.print();t.close()}};t.document.close()}toggleFullScreen(){this.viewer.setFullScreen(!this.viewer.isFullPage())}destroyViewer(){this.viewer&&(this.viewer.destroy(),this.viewer=null)}dispose(){this.hideRubberBand();this.selectionDiv?.remove();this.buttonContainer?.remove();this.destroyViewer()}}window.MudExImageViewer=n;