@using MudBlazor.Extensions.Core
@inherits MudExBaseComponent<MudExCaptureOptionsEdit>


<div class="@Class" style="@GetStyleStr()">
    @if (Value != null)
    {
        <MudExSplitPanel SplitterSize="1" UpdateSizesInPercentage="true" Splittable="false" ColumnLayout="true" Style="margin-bottom: 50px;">
            <Left>
                <MudStack StretchItems="StretchItems.End" Style="width: 60%">
                    <MudExGroupBox Text="@TryLocalize("Preview")">
                        <MudPaper Class="ma-3 pa-3" Elevation="3">
                            <MudGrid Spacing="0" Justify="Justify.Center">
                                @if (_screenTrack != null)
                                {
                                    <MudFab Style="@StopPreviewButtonStyle()" Color="Color.Error" OnClick="@StopPreviewScreenTrack" StartIcon="@Icons.Material.Filled.Close" Size="Size.Small" />
                                }
                                <MudPaper @onmousemove="OnDrag" @onmouseup="EndDrag" Style="@GetPreviewContainerStyle()">
                                    <div style="@GetMainCapturePreviewStyle()">
                                        <video style="height: 100%; width: 100%" @ref="_previewScreen"></video>
                                    </div>
                                    <div @ref="_overlayContainer"
                                         @onmouseup="@DetachResize"
                                         @onmousedown="@AttachResize"
                                         class="@GetOverlayClass()"
                                         style="@GetOverlayPreviewStyle()">
                                        <video @onmousedown="StartDrag"
                                               @onmouseup="EndDrag" style="height: 100%; width: 100%" @ref="_previewCamera"></video>
                                    </div>
                                </MudPaper>
                            </MudGrid>


                            @if (_captureScreen && !string.IsNullOrEmpty(Value?.VideoDevice?.DeviceId))
                            {
                                <MudGrid Spacing="1" Justify="Justify.SpaceBetween" Class="mt-1">
                                    @* <MudExEnumSelect OpenIcon="@Icons.Material.Filled.Cameraswitch" Clearable="false" Variant="Variant.Outlined" @bind-Value="Value.OverlaySource" Label="@TryLocalize("Overlay Source")"></MudExEnumSelect> *@
                                    <MudIconButton OnClick="@ToogleOverlaySource" Size="Size.Small" Icon="@Icons.Material.Filled.Cameraswitch"></MudIconButton>
                                    <MudExEnumSelect Style="margin-left: 5px;" Clearable="false" Variant="Variant.Outlined" @bind-Value="Value.OverlayPosition" Label="@TryLocalize("Overlay Position")"></MudExEnumSelect>
                                </MudGrid>
                            }

                        </MudPaper>
                    </MudExGroupBox>
                    <MudExGroupBox Text="@TryLocalize("Capture Screen")" Class="pa-3">

                        <MudSwitch Style="margin: 7px;" Color="Color.Primary" UncheckedColor="Color.Default" T="bool" ValueChanged="@CaptureScreenChanged" Value="@_captureScreen" Label="@TryLocalize("Capture Screen")" />
                        
                        @if (_captureScreen)
                        {
                            <MudFab Class="mb-3" OnClick="@SelectScreen" StartIcon="@Icons.Material.Filled.ScreenShare" Label="@TryLocalize("Select screen")" />
                            <MudText @onclick="@(SelectScreen)" Typo="Typo.body2">@TryLocalize("Click here to choose a screen to capture. If not selected, you will be prompted when starting the recording.")</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Warning" Style="font-size: 0.875em;">
                                @TryLocalize("Note: Media options can't changed after a screen is selected")
                            </MudText>


                            <MudGrid Class="mt-6" Justify="Justify.FlexEnd">
                                <MudFab Disabled="@(_screenTrack != null)" StartIcon="@Icons.Material.Filled.CameraAlt" OnClick="@ChangeMediaOptions" Label="@TryLocalize("Change media options")" />
                            </MudGrid>
                        }

                    </MudExGroupBox>
                </MudStack>
            </Left>
            <Right>
                <MudStack StretchItems="StretchItems.End" Style="width: 40%">
                    <MudExGroupBox Text="@TryLocalize("Additional Video")" Class="pa-3">
                        <MudAutocomplete T="string" @bind-Value="@Value.ContentType"
                                         Label="@TryLocalize("VideoContentType")"
                                         Dense="@Dense"
                                         Disabled="@(string.IsNullOrEmpty(Value?.VideoDevice?.DeviceId))"
                                         ReadOnly="@ReadOnly"
                                         ResetValueOnEmptyText="true"
                                         CoerceText="false"
                                         CoerceValue="false"
                                         Placeholder="@TryLocalize("VideoContentType")"
                                         SearchFunc="@SearchVideoContentType"
                                         Clearable="true" />

                        <p>@TryLocalize("Video device")</p>
                        <MudExSelect T="VideoDevice"
                                     ItemCollection="@_videoDevices"
                                     Value="@Value.VideoDevice"
                                     ValueChanged="@VideoDeviceChanged"
                                     MultiSelection="false"
                                     SearchBox="true"
                                     SearchBoxVariant="Variant.Text"
                                     Dense="@Dense"
                                     SelectAll="false"></MudExSelect>
                    </MudExGroupBox>
                    <MudExGroupBox Text="@TryLocalize("Additional Audio")" Class="pa-3">
                        <MudAutocomplete T="string" @bind-Value="@Value.AudioContentType"
                                         Label="@TryLocalize("AudioContentType")"
                                         Dense="@Dense"
                                         Disabled="@((Value.AudioDevices?.Count ?? 0) <= 0)"
                                         ReadOnly="@ReadOnly"
                                         ResetValueOnEmptyText="true"
                                         CoerceText="false"
                                         CoerceValue="false"
                                         Placeholder="@TryLocalize("AudioContentType")"
                                         SearchFunc="@SearchAudioContentType"
                                         Clearable="true" />

                        <p>@TryLocalize("Audio devices")</p>
                        <MudExList T="AudioDevice" ItemCollection="@_audioDevices"
                                   SelectedValues="@Value.AudioDevices"
                                   Color="MudExColor.Inherit"
                                   MultiSelection="true"
                                   SelectedItemsChanged="@AudioDevicesChanged"
                                   SearchBox="true"
                                   SearchBoxBackgroundColor="@("var(--mud-palette-surface)")"
                                   SearchBoxVariant="Variant.Text"
                                   Dense="@Dense"
                                   SelectAll="false"
                                   Style="min-height: 200px; overflow-y: auto;"></MudExList>
                    </MudExGroupBox>
                </MudStack>
            </Right>
        </MudExSplitPanel>
    }
</div>
