@page "/deployments"


<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="d-flex flex-column h-100 p-4">
    <MudText Typo="Typo.h4" GutterBottom="true">Deployment History | Time Machine</MudText>
    <MudText Typo="Typo.subtitle1" GutterBottom="true">Here you can see and visit older versions to compare features and errors.</MudText>

    <MudDivider Class="mb-4" />
    
    @if (_deployments == null)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Medium" />
    }
    else if (_deployments.Length == 0)
    {
        <MudText Typo="Typo.body1">No deployments found.</MudText>
    }
    else
    {
        <MudTable Items="_deployments"
                  Hover="true"
                  Bordered="true"
                  Striped="true"
                  Virtualize="true"
                  Height="75vh"
                  Elevation="1">
            <HeaderContent>
                <MudTh>Date</MudTh>
                <MudTh>Project</MudTh>
                <MudTh>MudEx Version</MudTh>
                <MudTh>MudBlazor Version</MudTh>
                <MudTh>Environment</MudTh>
                <MudTh>Link</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Date">
                    @context.CreatedOn.ToString("dd.MM.yyyy HH:mm")
                    <MudText Typo="Typo.caption" Class="ml-2">(@GetRelativeTime(context.CreatedOn))</MudText>
                </MudTd>
                <MudTd DataLabel="Project">@context.ProjectName</MudTd>
                <MudTd DataLabel="MudEx Version">
                    <MudChip T="Deployment" Color="Color.Primary"
                             Variant="Variant.Outlined">
                        @context.AssemblyVersion
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="MudBlazor Version">
                    <MudChip T="Deployment" Color="Color.Info"
                             Variant="Variant.Outlined">
                        @context.MudBlazorVersion
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Environment">@context.Environment</MudTd>
   
                <MudTd DataLabel="Link">
                    <MudExIconButton Href="@context.Url"
                                     Target="_blank"
                                     Icon="@Icons.Material.Filled.OpenInNew"
                                     Color="Color.Primary"
                                     Size="Size.Small"
                                     ToolTip="Open deployment URL" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
    
</MudContainer>

@code {
    private Deployment[]? _deployments = null;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);
        if (firstRender)
        {
            _deployments = await Deployments.GetAllDeploymentsAsync();
            
            StateHasChanged();
        }
    }

    private string GetRelativeTime(DateTime dt)
    {
        var span = DateTime.Now - dt;
        if (span.TotalDays >= 1)
            return span.Days == 1 ? "1 day ago" : $"{span.Days} days ago";
        if (span.TotalHours >= 1)
            return span.Hours == 1 ? "1 hour ago" : $"{span.Hours} hours ago";
        if (span.TotalMinutes >= 1)
            return span.Minutes == 1 ? "1 minute ago" : $"{span.Minutes} minutes ago";
        return "just now";
    }
}
